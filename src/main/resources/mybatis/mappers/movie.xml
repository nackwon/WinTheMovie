<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="movie"> <!--클래스명은 xml명과 똑같을 필요 없음-->
    
     <!-- 쿼리문 작성 -->
     <select id="getTheaterList" resultType="nowpVo">
    	<![CDATA[
			select  n.nowplayingno, 
    				n.roomno, 
    				n.movieno, 
    				to_char(n.playingtime,'YYYY-MM-DD HH24:MI:SS') as playingtime, 
    				to_char(n.playingdate,'YYYY-MM-DD') as playingdate, 
    				m.poster, 
    				tr.theaterno, 
    				t.brandno, 
    				t.theatername,
					t.theateraddress, 
					t.theaterxgps, 
					t.theaterygps, 
					b.brandlogo, 
					b.brandname
			from nowplaying n, movie m, THEATERROOM tr, theater t, brand b
			where  n.movieno = m.movieno and n.roomno = tr.roomno and tr.theaterno = t.theaterno and t.brandno = b.brandno
			and (n.playingtime - sysdate) *24*60*60 > 0 
			and n.playingtime between to_date(concat(to_char(sysdate, 'yyyy-mm-dd'), '04:00:01'), 'yyyy-mm-dd hh24:mi:ss')
			and to_date(concat(to_char(sysdate+7, 'yyyy-mm-dd'), '04:00:00'), 'yyyy-mm-dd hh24:mi:ss')
			and to_char(n.playingtime,'YYYY-MM-DD') = to_char(n.playingdate,'YYYY-MM-DD')
			order by n.playingtime asc			
	 ]]>	
    </select> 


    <select id="getQuickReserve" resultType="quickReserveVo">
	<![CDATA[
			select n.MOVIENO, n.ROOMNO, to_char(n.PLAYINGTIME,'HH24:MI') as playingtime, TO_CHAR(n.PLAYINGDATE, 'yyyy-mm-dd') as playingdate, m.KONAME, m.POSTER, m.grade, t.theatername, tr.SEATCOUNT, t.brandno, t.theatername
			from NOWPLAYING n, MOVIE m, THEATERROOM tr, THEATER t
			where #{nowplayingno}=n.movieno and n.movieno = m.movieno and n.ROOMNO = tr.ROOMNO and tr.theaterno = t.THEATERNO
        ]]>
    </select>

    <select id="getIsSeat" resultType="seatVo">
		<![CDATA[
			select s.SEATNAME , s.ISSEAT
			from seat s
			where #{nowplayingno}=s.NOWPALYINGNO
        ]]>
    </select>
    
    <select id="detailView" parameterType="int" resultType="detailVo">
    	<![CDATA[
			select n.nowplayingno, 
				   to_char(n.playingtime,'YYYY-MM-DD HH24:MI:SS') as playingtime, 
    			   to_char(n.playingdate,'YYYY-MM-DD') as playingdate,
				   tr.roomno,
				   tr.theaterno,
				   tr.screen,
				   t.theatername,
				   t.theateraddress,
				   t.theaterxgps,
				   t.theaterygps,
				   b.brandname,
				   b.brandNo,
				   b.brandlogo,
				   m.movieno,
				   m.directorno,
 				   m.actorno,
				   m.koname,
				   m.enname,
				   m.grade,
				   m.genre,
				   m.story,
				   m.openning,
				   m.poster,
				   m.runtime,
				   a.actorname,
				   d.directorname,
				   (select count(*) from stillcut s where s.movieno = m.movieno) as stillnum,
				   (select count(*) from stillmovie sm where sm.movieno = m.movieno) as stillmvnum
			from nowplaying n, movie m, theaterroom tr, theater t, brand b, actor a, director d
			where n.nowplayingno=#{nowplayingno} and n.movieno=m.movieno and n.roomno=tr.roomno and tr.theaterno=t.theaterno and t.brandno=b.brandno 
			and m.actorno=a.actorno and m.directorno=d.directorno
        ]]>
    </select>
    
    <select id="detailStillcut" parameterType="int" resultType="detailVo">
    	<![CDATA[
			select s.stillno, 
				   m.movieno, 
				   s.stillname, 
				   s.savename
			from movie m, stillcut s
			where m.movieno = #{movieno} and m.movieno = s.movieno
			order by s.stillno asc	
        ]]>
    </select>
    
    <select id="detailStillmovie" parameterType="int" resultType="detailVo">
    	<![CDATA[
    		select sm.stillmvno, 
    		       sm.stillmvname, 
    		       sm.stillmvurl,
    		       sm.stillmvimg, 
    		       m.movieno
        	from movie m, stillmovie sm
        	where m.movieno = #{movieno} and m.movieno = sm.movieno
			order by sm.stillmvno asc		
    	]]>
    </select>
    
    <select id="movieReview" parameterType="map" resultType="reviewVo">
       <![CDATA[
    	   select t.nowplayingno, u.userno, n.movieno, m.koname
           from ticket t ,(select userno from users where email=#{userEmail})u, nowplaying n, movie m
           where  n.movieno=#{movieno} and t.nowplayingno = n.nowplayingno and n.movieno = m.movieno
       ]]>
    </select>
   
</mapper>